---
title: "R Notebook"
output: html_notebook
---

#importing dataset and getting initial EDA of dataset
```{r}
library(readxl)
library(data.table)
den = read_excel("DEN 2012 - Jun 17.xlsx")
den = data.table(den)
head(den)
summary(den)

#converted `Cannibas?` hype and no hype values to binary, however discovered character values did not impact model so removed dummy variable creation
#den$`Cannibas?`[den$`Cannibas?` == 'hype'] = 1
#den$`Cannibas?`[den$`Cannibas?` == 'no hype'] = 0
```
#selecting columns by non-airline revenues (response variable) and `Month` & `Year`
```{r}
library(dplyr)
den1 = select(den, "Month and Year", Concession:Ground)
head(den1)
```
#slice `Month` and `Year` column using tidyr
#observe sum totals of Non-airline revenues using janitor
```{r}
library(tidyr)
separate_time = den1 %>% 
  separate("Month and Year", c('Day', 'Month', 'Year'))
den2 = select(separate_time, -Day)
#splitting date for all variables in dataset
separate_time1 = den %>% 
  separate("Month and Year", c('Day', 'Month', 'Year'))
den7 = select(separate_time1, -Day); den7

library(janitor)
den3 = den2 %>%
  adorn_totals("col"); den3
```
#summarize average non-airline revenue by `Month` and `Year` using dplyr
```{r}
avg.month = den2 %>%
  group_by(Month) %>%
  summarise_each(funs(mean, n()), Concession, Parking, "Rental Car", Ground)
avg.month
sum.month.avgs = apply(avg.month[,2:5],1,sum); sum.month.avgs
#df.month = new dataframe joining sum of averages from variables that make up response with `Month`
df.month = data.frame(cbind(avg.month["Month"],sum.month.avgs)); df.month

#transpose df.month dataframe for use in executive summary
View(t(df.month))

avg.year = den2 %>%
  group_by(Year) %>%
  summarise_each(funs(mean, n()), Concession, Parking, "Rental Car", Ground)
avg.year
sum.year.avgs = apply(avg.year[,2:5],1,sum); sum.year.avgs
#df.year = new dataframe joining sum of averages from variables that make up response with `Year`
df.year = data.frame(cbind(avg.year["Year"], sum.year.avgs)); df.year
```
#Visualizations: Non-airline revenues by `Month` and `Year` with ggplot2
```{r}
library(ggplot2)
revplot.total = ggplot(df.month, aes(x = Month, y = sum.month.avgs)) + geom_point(size = 3, colour = "green") + ggtitle("Total Avg Non-airline Revenue by Month"); revplot.total + theme_dark()
revplot1 = ggplot(den2, aes(x = Month, y = Concession)) + geom_point(size = 2, colour = "red") + ggtitle("Concession revenue by Month"); revplot1 + theme_dark()
revplot2 = ggplot(den2, aes(x = Month, y = Parking)) + geom_point(size = 2, colour = "orange") + ggtitle("Parking revenue by Month"); revplot2 + theme_dark()
revplot3 = ggplot(den2, aes(x = Month, y = `Rental Car`)) + geom_point(size = 2, colour = "yellow") + ggtitle("Rental Car revenue by Month"); revplot3 + theme_dark()
revplot4 = ggplot(den2, aes(x = Month, y = Ground)) + geom_point(size = 2, colour = "black") + ggtitle("Ground revenue by Month"); revplot4 + theme_dark()

#all non-airline revenue dependent variables have positive linear relationship with `Year`
revplot.total.1 = ggplot(df.year, aes(x = Year, y = sum.year.avgs)) + geom_point(size = 3, colour = "blue") + ggtitle("Total Avg Non-airline Revenue by Year"); revplot.total.1 + theme_dark()
revplot5 = ggplot(den2, aes(x = Year, y = Concession)) + geom_point(size = 2, colour = "purple") + ggtitle("Concession revenue by Year"); revplot5 + theme_dark()
revplot6 = ggplot(den2, aes(x = Year, y = Parking)) + geom_point(size = 2, colour = "dark green") + ggtitle("Parking revenue by Year"); revplot6 + theme_dark()
revplot7 = ggplot(den2, aes(x = Year, y = `Rental Car`)) + geom_point(size = 2, colour = "dark blue") + ggtitle("Rental Car revenue by Year"); revplot7 + theme_dark()
revplot8 = ggplot(den2, aes(x = Year, y = Ground)) + geom_point(size = 2, colour = "dark red") + ggtitle("Ground revenue by Year"); revplot8 + theme_dark()

#looked at melting all the values directly in one column for quick analysis
library(reshape2)
df.plot = data.frame(den2$Concession, den2$Parking, den2$`Rental Car`, den2$Ground)
df.plot.table = data.table(df.plot)
df.m.total = melt(df.plot.table); df.m.total

#layered plots showing relationships between non-airline revenue and `Month` & `Year`
ggplot(den2) + geom_point(aes(den2$Month,den2$Parking, colour = "Parking")) + geom_point(aes(den2$Month,den2$`Rental Car`, colour = "Rental Car")) + geom_point(aes(den2$Month,den2$Ground, colour = "Ground")) + geom_point(aes(den2$Month, den2$Concession, colour = "Concession")) + labs(x = "Months", y = "Revenue", title = "Non-airline Revenue by Month") + theme_dark()

ggplot(den2) + geom_point(aes(den2$Year,den2$Parking, colour = "Parking")) + geom_point(aes(den2$Year,den2$`Rental Car`, colour = "Rental Car")) + geom_point(aes(den2$Year,den2$Ground, colour = "Ground")) + geom_point(aes(den2$Year, den2$Concession, colour = "Concession")) + labs(x = "Years", y = "Revenue", title = "Non-airline Revenue by Year") + theme_dark()

#Grouped non-airline revenue by `Year` for easy analysis
rev.year = den3 %>%
  group_by(Year) %>%
  summarise_each(funs(sum, n()), Total); rev.year

#plot of total sum of non-airline revenue by `Year`
ggplot(rev.year, aes(x = Year, y = sum)) + geom_smooth() + geom_point(size = 3, color = "green") + labs(x = "Years 2012 - 2017", y = "Revenue", title = "Total Sum of Non-airline Revenue by Year", caption = "*2017 revenues only accrued Jan - June")+ theme_dark()
```
#trimmed top 3 rows from dataframe to avoid incorrect results from NA values
#adding observation column to try and predict model over time
#adding totalrev column for response variables
```{r}
den4 = den7[4:66,]
den4$ObsNumber =  1:nrow(den4)
den4$TotalRev = (den4$Concession + den4$Parking + den4$`Rental Car` + den4$Ground)
```

#Model 1: Total sum dependent variables + IVs: (Month, Destination, Cannibas, UMCSENTLag3)
```{r}
library(car)

#using log transformation on dependent variable due to using lagged explanatory variable
mod1 = lm(log(den4$TotalRev) ~ den4$Month + den4$Destination + den4$`Cannibas?` + den4$UMCSENTLag3)
summary(mod1)
plot(den4$TotalRev, mod1$residuals, xlab = 'pred', ylab = 'res', main = 'Residuals vs Predicted')
abline(h=0, col='red')
qqnorm(mod1$residuals)
qqline(mod1$residuals, col=2)
hist(mod1$residuals)
AIC(mod1)
BIC(mod1)
vif(mod1)
durbinWatsonTest(mod1)
anova(mod1)
#adjusted r2: 0.8555
#AIC: -185.4749 is by far the lowest = more parsimonious model
#BIC: -151.1847
#DW test: p=0.36 Do not reject H0 and no autocorrelation

#RMSE from summary: the square root of the residual deviance per degree of freedom
#977992

#inverse transformation of log base e on RMSE
library(stats)
sigma(mod1)

den4$TotalRevlog = log(den4$TotalRev)

rmset <- function(model){
  y = den4$TotalRevlog
  y.pred = predict(model)
  
  y<-exp(y) - 1
  y.pred<-exp(y.pred)-1
  
  return(sqrt(mean((y - y.pred)^2)))
} 
rmset (mod1)

#Looked at adding den4$ObsNumber predictor but eventually decided to remove this IV as it didn't increase the accuracy of the model in this case.
```





























